<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="X-Permitted-Cross-Domain-Policies" content="none">
  <meta http-equiv="X-Download-Options" content="noopen">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lumber Dealer Permit Dashboard v13 - CNC</title>

  <!-- Tailwind + icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }

    .dashboard-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
    .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }

    .stat-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }

    /* Freeze table header */
    .table-container thead th {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f9fafb;
      backdrop-filter: blur(4px);
    }

    .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
    .search-box { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .filter-btn { transition: all 0.3s ease; }
    .filter-btn:hover { transform: scale(1.05); }

    .status-active { background: linear-gradient(135deg, #10b981, #059669); }
    .status-expiring { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .status-expired { background: linear-gradient(135deg, #ef4444, #dc2626); }

    .animate-fade-in { animation: fadeIn 0.6s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }

    .data-row { transition: all 0.2s ease; }
    .data-row:hover { background-color: #f8fafc; transform: scale(1.01); }

    .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;}
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .version-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }

    /* Profile dropdown/modal small tweaks */
    .profile-btn { display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:9999px; background: rgba(255,255,255,0.06); color:white; border:1px solid rgba(255,255,255,0.05);}
    .role-badge-admin { background:#dc2626; color:white; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:600; }
    .role-badge-staff { background:#2563eb; color:white; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:600; }

    /* modal backdrop */
    .modal-backdrop { background: rgba(17,24,39,0.6); }

    /* responsive adjustments */
    @media (max-width: 640px) {
      .max-h-table { max-height: 60vh; }
      .profile-details { display:none; } /* hide long name on small screens inside header */
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-amber-50 min-h-screen">

  <!-- Firebase + Profile UI will inject content -->
  <!-- Header (non-sticky per request) -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-gradient-to-r from-amber-600 to-orange-700 rounded-lg flex items-center justify-center">
            <i class="fas fa-industry text-white text-lg"></i>
          </div>
          <div>
            <div class="flex items-center space-x-3">
              <h1 class="text-2xl font-bold text-gray-900">Lumber Dealer Permit Dashboard</h1>
              <span class="version-badge">v13</span>
            </div>
            <p class="text-sm text-gray-600">CENRO New Corella Management System</p>
          </div>
        </div>

        <!-- Right: last updated + profile area -->
        <div class="flex items-center space-x-4">
          <div class="text-right mr-2">
            <p class="text-sm text-gray-600">Philippine Standard Time</p>
            <p class="text-sm font-semibold text-gray-900" id="lastUpdated">—</p>
          </div>

          <!-- Profile dropdown area (populated by JS) -->
          <div id="headerProfile" class="relative"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8 animate-fade-in">
      <div class="stat-card p-6"> <!-- Total Permits -->
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Permits</p>
            <p class="text-3xl font-bold text-gray-900" id="totalLicenses">0</p>
          </div>
          <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-certificate text-amber-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-amber-600 font-medium" id="totalLicensesChange"><i class="fas fa-sync-alt fa-spin"></i> Loading...</span>
        </div>
      </div>

      <div class="stat-card p-6"> <!-- Active -->
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Active Permits</p>
            <p class="text-3xl font-bold text-green-600" id="activeLicenses">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600" id="activeLicensesText">Currently valid</span>
        </div>
      </div>

      <div class="stat-card p-6"> <!-- Expiring -->
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Expiring Soon</p>
            <p class="text-3xl font-bold text-yellow-600" id="expiringSoon">0</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Next 3 months</span>
        </div>
      </div>

      <div class="stat-card p-6"> <!-- Expired -->
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Expired</p>
            <p class="text-3xl font-bold text-red-600" id="expiredLicenses">0</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-times-circle text-red-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Need renewal</span>
        </div>
      </div>

      <div class="stat-card p-6"> <!-- Holders -->
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Establishments</p>
            <p class="text-3xl font-bold text-blue-600" id="totalHolders">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-users text-blue-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Registered establishments</span>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8 animate-fade-in">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
        <div class="flex flex-wrap gap-3">
          <button data-filter="all" class="filter-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 ring-2 ring-blue-300" onclick="filterTable('all')">
            <i class="fas fa-list mr-2"></i>All Permits
          </button>
          <button data-filter="active" class="filter-btn px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700" onclick="filterTable('active')">
            <i class="fas fa-check mr-2"></i>Active
          </button>
          <button data-filter="expiring-soon" class="filter-btn px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700" onclick="filterTable('expiring-soon')">
            <i class="fas fa-clock mr-2"></i>Expiring Soon
          </button>
          <button data-filter="expired" class="filter-btn px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700" onclick="filterTable('expired')">
            <i class="fas fa-times mr-2"></i>Expired
          </button>
          <button class="filter-btn px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700" onclick="exportData()">
            <i class="fas fa-download mr-2"></i>Export CSV
          </button>
          <button class="filter-btn px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700" onclick="refreshData()">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>

        <div class="relative">
          <input type="text" id="searchInput" placeholder="Search lumber dealer permits..." class="search-box pl-10 pr-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-500 focus:outline-none w-full lg:w-80">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container animate-fade-in">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-table mr-2 text-amber-600"></i>
              Lumber Dealer Permit Registry
            </h3>
            <p class="text-sm text-gray-600 mt-1">Complete list of lumber dealer permits and establishments</p>
          </div>
          <div class="text-sm text-gray-500" id="dataStatus"><i class="fas fa-database mr-1"></i>Connected to Google Sheets</div>
        </div>
      </div>

      <!-- Scrollable body with frozen header -->
      <div class="overflow-x-auto" id="tableContainer">
        <div class="max-h-[600px] overflow-y-auto max-h-table">
          <table class="w-full" id="licenseTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-industry mr-2"></i>Establishment</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-map-marker-alt mr-2"></i>Location/ Address</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-hashtag mr-2"></i>Permit Number</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-calendar-check mr-2"></i>Date Approved</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-calendar-times mr-2"></i>Expiry Date</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-user-tie mr-2"></i>Owner/ Representative</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-user-check mr-2"></i>Data Provider</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-clock mr-2"></i>Time Until Expiry</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-info-circle mr-2"></i>Status</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
              <tr>
                <td colspan="9" class="px-6 py-12 text-center">
                  <div class="loading-spinner mx-auto mb-4"></div>
                  <p class="text-gray-500">Loading permit data from Google Sheets...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-sm text-gray-600">
      <p>Data provided by CENRO New Corella</p>
      <p class="mt-2">© 2025 Lumber Dealer Permit Management System • Version 13</p>
    </div>
  </div>

  <!-- Profile Modal (inline) -->
  <div id="profileModal" class="hidden fixed inset-0 z-60 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="closeProfileModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 z-70">
      <div class="flex justify-between items-start">
        <div class="flex items-center gap-4">
          <img id="modalPhoto" src="" alt="photo" class="w-20 h-20 rounded-full object-cover border-4 border-green-600">
          <div>
            <h2 id="modalName" class="text-xl font-bold text-gray-900">User Name</h2>
            <p id="modalEmail" class="text-sm text-gray-600">email@example.com</p>
            <div id="modalRole" class="mt-2 inline-block px-3 py-1 rounded-md text-white font-medium"></div>
          </div>
        </div>
        <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>

      <div class="mt-6">
        <p class="text-sm text-gray-700">Profile details fetched from Firebase Auth and Firestore (<code>users/{uid}</code>).</p>
        <div class="mt-4 flex gap-3">
          <button onclick="closeProfileModal()" class="px-4 py-2 bg-gray-200 rounded-lg">Close</button>
          <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase scripts + logic -->
  <script type="module">
    // --- Firebase SDK (v10 modules) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Replace with your project's config if different ---
    const firebaseConfig = {
      apiKey: "AIzaSyD2xLVGe79OxzEHC2uXNMcbCtWugGn2M_k",
      authDomain: "simple-logon.firebaseapp.com",
      projectId: "simple-logon",
      storageBucket: "simple-logon.firebasestorage.app",
      messagingSenderId: "698709393716",
      appId: "1:698709393716:web:5d93c85f962769d8a42561",
      measurementId: "G-H25FHTK2S5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Logout function available globally for buttons
    window.logout = async function logout() {
      try {
        await signOut(auth);
        window.location.href = "/index.html";
      } catch (err) {
        console.error("Sign out error:", err);
        window.location.href = "/index.html";
      }
    };

    // Build header profile UI when user is logged in
    async function buildProfileHeader(user) {
      const headerProfile = document.getElementById('headerProfile');
      headerProfile.innerHTML = ''; // reset

      // default values (fallback)
      const name = user.displayName || 'User';
      const email = user.email || '';
      const photo = user.photoURL || '';
      let role = 'Staff';

      // fetch user doc from Firestore users/{uid}
      try {
        const udoc = await getDoc(doc(db, 'users', user.uid));
        if (udoc.exists()) {
          const data = udoc.data();
          if (data.role) role = data.role;
        }
      } catch (e) {
        console.warn('Failed to read users/{uid} role:', e);
      }

      // Normalize role for display (Admin vs Staff)
      const roleText = (role || 'Staff').toString();
      const roleClass = roleText.toLowerCase() === 'admin' ? 'role-badge-admin' : 'role-badge-staff';
      const roleLabel = roleText.charAt(0).toUpperCase() + roleText.slice(1);

      // header button markup
      const btn = document.createElement('div');
      btn.innerHTML = `
        <button id="profileToggle" aria-expanded="false" class="profile-btn flex items-center gap-3 px-3 py-2 rounded-full">
          <img src="${photo}" alt="profile" onerror="this.src='https://www.gravatar.com/avatar/?d=mp&s=64';" class="w-8 h-8 rounded-full object-cover border border-white/20">
          <div class="profile-details text-left">
            <div class="text-xs text-white/90 font-semibold">${name}</div>
            <div class="text-xs text-white/70">${email}</div>
          </div>
          <span class="${roleClass}">${roleLabel}</span>
          <i class="fas fa-chevron-down text-white/90"></i>
        </button>

        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden border border-gray-100">
          <a href="#" id="viewProfile" class="block px-4 py-3 hover:bg-gray-50 text-gray-700">View Profile</a>
          <a href="#" id="viewProfile2" class="block px-4 py-3 hover:bg-gray-50 text-gray-700">Open Profile</a>
          <button id="logoutBtn" class="w-full text-left px-4 py-3 hover:bg-red-50 text-red-600">Logout</button>
        </div>
      `;

      headerProfile.appendChild(btn);

      const toggle = document.getElementById('profileToggle');
      const menu = document.getElementById('profileMenu');
      const logoutBtn = document.getElementById('logoutBtn');
      const viewProfile = document.getElementById('viewProfile');

      // Toggle menu on click (mobile & desktop)
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = !menu.classList.contains('hidden');
        if (open) {
          menu.classList.add('hidden');
          toggle.setAttribute('aria-expanded', 'false');
        } else {
          menu.classList.remove('hidden');
          toggle.setAttribute('aria-expanded', 'true');
        }
      });

      // Close menu when clicking outside
      document.addEventListener('click', (ev) => {
        if (!btn.contains(ev.target)) {
          menu.classList.add('hidden');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });

      // menu actions
      viewProfile.addEventListener('click', (e) => {
        e.preventDefault();
        openProfileModal({ name, email, photo, role: roleLabel });
        menu.classList.add('hidden');
      });

      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await logout();
      });
    }

    function openProfileModal({ name, email, photo, role }) {
      document.getElementById('modalName').textContent = name || 'User';
      document.getElementById('modalEmail').textContent = email || '';
      document.getElementById('modalPhoto').src = photo || 'https://www.gravatar.com/avatar/?d=mp&s=160';
      const modalRole = document.getElementById('modalRole');
      modalRole.textContent = role || 'Staff';
      modalRole.className = role.toLowerCase() === 'admin' ? 'mt-2 inline-block px-3 py-1 rounded-md text-white role-badge-admin' : 'mt-2 inline-block px-3 py-1 rounded-md text-white role-badge-staff';
      document.getElementById('profileModal').classList.remove('hidden');
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.add('hidden');
    }

    // Auth state observer + admin check (redirect if not logged in)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // not logged in -> send to login page
        window.location.href = "/index.html";
        return;
      }

      // Build header/profile UI now that user exists
      buildProfileHeader(user);

      // optionally verify admin role and redirect if needed:
      try {
        const udoc = await getDoc(doc(db, 'users', user.uid));
        if (udoc.exists()) {
          const data = udoc.data();
          // If you want to restrict the page to admins only, uncomment below:
          // if (!data.role || data.role.toLowerCase() !== 'admin') { window.location.href = '/agreement/'; return; }
        }
      } catch (err) {
        console.warn('Error reading user doc:', err);
      }
    });

    // small helper to expose modal closing
    window.closeProfileModal = closeProfileModal;
  </script>

  <!-- Main Dashboard logic (your CSV loading + table code) -->
  <script>
    // Keep your functions but with a small fix for filter button state handling
    let allData = [];
    let currentFilter = 'all';
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', function() {
      updateLastUpdated();
      initializeSearch();
      loadDataFromGoogleSheets();
      setInterval(() => { updateCountdownTimers(); updateLastUpdated(); }, 1000);
    });

    function updateLastUpdated() {
      const now = new Date();
      const formatted = now.toLocaleDateString('en-PH', {
        timeZone: 'Asia/Manila',
        month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
      });
      document.getElementById('lastUpdated').textContent = formatted;
    }

    function updateCountdownTimers() {
      const countdownCells = document.querySelectorAll('.countdown-cell');
      countdownCells.forEach(cell => {
        const expiryDate = cell.getAttribute('data-expiry');
        if (expiryDate) cell.innerHTML = getCountdownTimer(expiryDate);
      });
    }

    async function loadDataFromGoogleSheets() {
      if (isLoading) return;
      isLoading = true;
      try {
        updateDataStatus('Loading data...', 'text-yellow-600');
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSwGBYZbKiE-Z_YNKnYz59B7uS_nmxFJd85mRrPFK03W_B0HOADgr2D5q7mT8Kt17-xFhrIiSk8eq0H/pub?gid=695880952&single=true&output=csv');
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const csvText = await response.text();
        const lines = csvText.split('\n').filter(l => l.trim());
        if (lines.length < 2) { loadSampleData(); return; }
        const headers = parseCSVLine(lines[0]);
        allData = [];
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length >= 1 && values[0].trim()) {
            allData.push({
              establishment: values[0] || '',
              location: values[1] || '',
              permitNumber: values[2] || '',
              dateApproved: values[3] || '',
              expiryDate: values[4] || '',
              owner: values[5] || '',
              dataProvider: values[6] || values[7] || 'Carmalyn C. Nesperos / RPS-LPU'
            });
          }
        }
        if (allData.length > 0) { populateTable(); calculateStats(); updateDataStatus(`${allData.length} permits loaded`, 'text-green-600'); }
        else { loadSampleData(); }
      } catch (err) {
        console.error(err); updateDataStatus('Using sample data', 'text-yellow-600'); loadSampleData();
      } finally { isLoading = false; updateLastUpdated(); }
    }

    function loadSampleData() {
      allData = [
        { establishment:'Davao Lumber Trading Co.', location:'San Roque, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD01-R-03152029', dateApproved:'March 15, 2024', expiryDate:'March 15, 2029', owner:'Roberto Martinez', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' },
        { establishment:'New Corella Lumber Supply', location:'Poblacion, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD02-R-07202028', dateApproved:'July 20, 2023', expiryDate:'July 20, 2028', owner:'Maria Santos', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' },
        { establishment:'Mountain View Lumber Depot', location:'Cabcab, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD03-R-04102025', dateApproved:'April 10, 2020', expiryDate:'April 10, 2025', owner:'Juan dela Cruz', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' },
        { establishment:'Golden Timber Dealers', location:'Mesaoy, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD04-R-11052030', dateApproved:'November 5, 2025', expiryDate:'November 5, 2030', owner:'Ana Reyes', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' },
        { establishment:'Pacific Lumber Traders', location:'San Isidro, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD05-R-09122027', dateApproved:'September 12, 2022', expiryDate:'September 12, 2027', owner:'Carlos Garcia', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' },
        { establishment:'Sunrise Lumber Dealers', location:'Tagum Road, New Corella, Davao del Norte', permitNumber:'DENRXI-2A-LD06-R-01152023', dateApproved:'January 15, 2018', expiryDate:'January 15, 2023', owner:'Elena Rodriguez', dataProvider:'Carmalyn C. Nesperos / RPS-LPU' }
      ];
      populateTable(); calculateStats(); updateDataStatus('Sample data loaded', 'text-blue-600');
    }

    function updateDataStatus(message, colorClass) {
      const statusEl = document.getElementById('dataStatus');
      statusEl.innerHTML = `<i class="fas fa-database mr-1"></i>${message}`;
      statusEl.className = `text-sm ${colorClass}`;
    }

    function parseCSVLine(line) {
      const result = []; let current = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
        else { current += char; }
      }
      result.push(current.trim());
      return result;
    }

    function getLicenseStatus(expiryDate) {
      if (!expiryDate) return { status: 'Unknown', class: 'status-expired' };
      const expiry = new Date(expiryDate); const today = new Date();
      const threeMonthsFromNow = new Date(); threeMonthsFromNow.setMonth(today.getMonth() + 3);
      if (expiry < today) return { status: 'Expired', class: 'status-expired' };
      else if (expiry <= threeMonthsFromNow) return { status: 'Expiring Soon', class: 'status-expiring' };
      else return { status: 'Active', class: 'status-active' };
    }

    function getCountdownTimer(expiryDate) {
      if (!expiryDate) return '<span class="text-gray-400">No expiry date</span>';
      const expiry = new Date(expiryDate); const now = new Date(); const timeDiff = expiry.getTime() - now.getTime();
      if (timeDiff <= 0) return '<span class="text-red-600 font-semibold">EXPIRED</span>';
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
      let colorClass = 'text-green-600'; if (days < 30) colorClass = 'text-red-600'; else if (days < 90) colorClass = 'text-yellow-600';
      return `<div class="${colorClass} font-mono text-sm"><div class="font-semibold">${days} days</div><div class="text-xs">${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}</div></div>`;
    }

    function populateTable() {
      const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
      allData.forEach(row => {
        const status = getLicenseStatus(row.expiryDate);
        const tr = document.createElement('tr'); tr.className = 'data-row'; tr.setAttribute('data-status', status.status.toLowerCase().replace(' ', '-'));
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-industry text-amber-600"></i>
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">${row.establishment}</div>
                <div class="text-sm text-gray-500">Lumber Dealer</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.location}</td>
          <td class="px-6 py-4 text-sm font-mono text-gray-900">${row.permitNumber}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.dateApproved}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.expiryDate}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.owner}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.dataProvider}</td>
          <td class="px-6 py-4 countdown-cell" data-expiry="${row.expiryDate}">
            ${getCountdownTimer(row.expiryDate)}
          </td>
          <td class="px-6 py-4">
            <span class="${status.class} inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white">
              <i class="fas ${status.status === 'Active' ? 'fa-check-circle' : status.status === 'Expiring Soon' ? 'fa-clock' : 'fa-times-circle'} mr-1"></i>
              ${status.status}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function calculateStats() {
      const total = allData.length; let active = 0, expiring = 0, expired = 0;
      allData.forEach(row => { const status = getLicenseStatus(row.expiryDate); if (status.status === 'Active') active++; else if (status.status === 'Expiring Soon') expiring++; else if (status.status === 'Expired') expired++; });
      document.getElementById('totalLicenses').textContent = total;
      document.getElementById('activeLicenses').textContent = active;
      document.getElementById('expiringSoon').textContent = expiring;
      document.getElementById('expiredLicenses').textContent = expired;
      document.getElementById('totalHolders').textContent = total;
      const activePercentage = total > 0 ? Math.round((active / total) * 100) : 0;
      document.getElementById('totalLicensesChange').innerHTML = `<i class="fas fa-arrow-up"></i> ${activePercentage}% Active`;
      document.getElementById('activeLicensesText').textContent = expired > 0 ? `${expired} expired permits` : 'Currently valid';
    }

    function initializeSearch() {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          const matchesSearch = text.includes(searchTerm);
          const matchesFilter = currentFilter === 'all' || row.getAttribute('data-status') === currentFilter;
          if (matchesSearch && matchesFilter) { row.style.display = ''; row.classList.add('animate-fade-in'); } else { row.style.display = 'none'; }
        });
      });
    }

    function filterTable(filter) {
      currentFilter = filter;
      const rows = document.querySelectorAll('#tableBody tr');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        const matchesFilter = filter === 'all' || row.getAttribute('data-status') === filter;
        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
      });
      // Update button visual state
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('ring-2','ring-blue-300');
        if (btn.getAttribute('data-filter') === filter) btn.classList.add('ring-2','ring-blue-300');
      });
    }

    function exportData() {
      if (allData.length === 0) { alert('No data available to export. Please load data first.'); return; }
      const headers = ['Establishment', 'Location/Address', 'Permit Number', 'Date Approved', 'Expiry Date', 'Owner/Representative', 'Data Provider', 'Days Until Expiry', 'Status'];
      const rows = allData.map(row => {
        const status = getLicenseStatus(row.expiryDate); const expiry = new Date(row.expiryDate); const now = new Date();
        const timeDiff = expiry.getTime() - now.getTime();
        const daysUntilExpiry = timeDiff > 0 ? Math.floor(timeDiff / (1000 * 60 * 60 * 24)) : 'EXPIRED';
        return [ row.establishment, row.location, row.permitNumber, row.dateApproved, row.expiryDate, row.owner, row.dataProvider, daysUntilExpiry, status.status ];
      });
      const csvContent = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'lumber-dealer-permits-v13-' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
      window.URL.revokeObjectURL(url);
    }

    function refreshData() { loadDataFromGoogleSheets(); }

    // Hover animations (keeps existing behavior)
    document.querySelectorAll('.stat-card, .table-container').forEach(el => {
      el.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-2px)'; });
      el.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; });
    });
  </script>

  <!-- extra small security scripts and handlers (unchanged) -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a33e2047d4fee5',t:'MTc1OTczMzYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>

  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.onkeydown = function(e) {
      if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0))) {
        return false;
      }
    };
  </script>
</body>
</html>
