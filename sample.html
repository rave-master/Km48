<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Home — Secure</title>
  <style>
    /* Simple styling */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb;color:#111}
    header{background:#0f172a;color:#fff;padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    nav a{color:#cbd5e1;margin-right:1rem;text-decoration:none}
    nav a.active{color:#fff;font-weight:600}
    .container{max-width:1000px;margin:2rem auto;padding:1rem}
    .card{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 6px 18px rgba(15,23,42,0.08)}
    .hidden{display:none}
    .btn{background:#0f172a;color:#fff;padding:.5rem .75rem;border-radius:6px;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08)}
    footer{padding:1rem;text-align:center;color:#64748b}
  </style>
</head>
<body>
  <header>
    <div class="brand">My App — Admin Home</div>
    <nav id="navbar">
      <!-- Links will be injected by JS according to role -->
    </nav>
    <div>
      <button id="signOutBtn" class="btn">Sign out</button>
    </div>
  </header>

  <main class="container">
    <section id="loading" class="card">Checking authentication and permissions...</section>

    <section id="forbidden" class="card hidden">
      <h2>Access denied</h2>
      <p>You do not have permission to view this page. If you believe this is an error, contact the site administrator.</p>
      <p><a href="/agreement/">Go back</a></p>
    </section>

    <section id="content" class="card hidden">
      <h1>Welcome, <span id="displayName">User</span></h1>
      <p id="roleLabel">Role: <strong id="roleText">user</strong></p>

      <hr />

      <h3>Quick links</h3>
      <ul id="quickLinks">
        <!-- role-based links injected here -->
      </ul>

      <div style="margin-top:1rem">
        <h4>Profile</h4>
        <pre id="profileDump" style="white-space:pre-wrap;background:#f1f5f9;padding:.75rem;border-radius:6px"></pre>
      </div>
    </section>
  </main>

  <footer>
    Secure admin area — users without admin role will be redirected.
  </footer>

  <!-- Firebase SDKs (modular v9) -->
  <script type="module">
    // Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- CONFIG (use your project's config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD2xLVGe79OxzEHC2uXNMcbCtWugGn2M_k",
      authDomain: "simple-logon.firebaseapp.com",
      projectId: "simple-logon",
      storageBucket: "simple-logon.firebasestorage.app",
      messagingSenderId: "698709393716",
      appId: "1:698709393716:web:5d93c85f962769d8a42561",
      measurementId: "G-H25FHTK2S5"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const forbiddenEl = document.getElementById('forbidden');
    const displayNameEl = document.getElementById('displayName');
    const profileDumpEl = document.getElementById('profileDump');
    const roleTextEl = document.getElementById('roleText');
    const navbarEl = document.getElementById('navbar');
    const quickLinksEl = document.getElementById('quickLinks');
    const signOutBtn = document.getElementById('signOutBtn');

    // Sign out handler
    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        // After sign out, send to public page
        window.location.href = '/';
      } catch (err) {
        alert('Sign out failed: ' + err.message);
      }
    });

    // Helper: show/hide
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    // Build navbar according to role
    function renderNavbar(isAdmin){
      navbarEl.innerHTML = '';
      const links = [];
      links.push({href:'/home/index.html', text:'Home'});
      links.push({href:'/profile/', text:'Profile'});
      if(isAdmin) links.push({href:'/admin/users.html', text:'Manage Users'});

      links.forEach(l => {
        const a = document.createElement('a');
        a.href = l.href;
        a.textContent = l.text;
        navbarEl.appendChild(a);
      });
    }

    // Build quick links list
    function renderQuickLinks(isAdmin){
      quickLinksEl.innerHTML = '';
      const items = [{text:'Open Profile', href:'/profile/'}, {text:'Documentation', href:'/docs/'}];
      if(isAdmin) items.unshift({text:'User Management', href:'/admin/users.html'});
      items.forEach(it => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${it.href}">${it.text}</a>`;
        quickLinksEl.appendChild(li);
      });
    }

    // Main auth guard: allow only admins
    onAuthStateChanged(auth, async (user) => {
      // Show loading while we check
      show(loadingEl);
      hide(contentEl);
      hide(forbiddenEl);

      if (!user) {
        // not signed-in → redirect to login
        window.location.href = '/login/';
        return;
      }

      try {
        // Ensure user profile exists (auto-create in 'users' collection)
        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        const isAdminDoc = (await getDoc(doc(db, 'admin', user.uid))).exists();

        if (!userSnap.exists()) {
          // create minimal profile
          await setDoc(userRef, {
            email: user.email || null,
            displayName: user.displayName || null,
            createdAt: serverTimestamp(),
            role: isAdminDoc ? 'admin' : 'user'
          }, { merge: true });
        } else {
          // If profile exists, optionally ensure role field exists/updated
          await setDoc(userRef, { role: isAdminDoc ? 'admin' : 'user' }, { merge: true });
        }

        // If user is admin → show content, otherwise redirect or show forbidden
        if (isAdminDoc) {
          // Render admin UI
          displayNameEl.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'Admin');
          roleTextEl.textContent = 'admin';
          profileDumpEl.textContent = JSON.stringify({ uid: user.uid, email: user.email, name: user.displayName }, null, 2);

          renderNavbar(true);
          renderQuickLinks(true);

          hide(loadingEl);
          show(contentEl);
          hide(forbiddenEl);
        } else {
          // Not an admin: redirect to /agreement/ (or show forbidden message)
          // Option A: redirect
          window.location.href = '/agreement/';

          // Option B: showForbidden instead of redirect
          // hide(loadingEl); show(forbiddenEl);
        }
      } catch (err) {
        console.error('Auth/Firestore check failed', err);
        alert('An error occurred. See console for details.');
        hide(loadingEl);
        show(forbiddenEl);
      }
    });

  </script>
</body>
</html>
