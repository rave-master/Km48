
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Monitoring Dashboard</title>
<link rel="icon" href="https://ia601205.us.archive.org/12/items/icon_20250717/icon.png" type="image/png">


<script>
    const AGREEMENT_VERSION = '2.1';

    // Check agreement in storage
    const storedVersion = sessionStorage.getItem('denr_agreement_version');
    const agreementAccepted = sessionStorage.getItem('denr_agreement_accepted');

    if (storedVersion !== AGREEMENT_VERSION || agreementAccepted !== 'true') {
        // Redirect to agreement page if not accepted
        window.location.href = '/index.html'; // Your cover page filename
    }
</script>


<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
  body { font-family: Arial, sans-serif;
  padding: 20px;
  
  /* Background image */
  background-image: url('/de.jpg');
  
  /* Make it cover the whole screen */
  background-size: cover;
  
  /* Keep it centered */
  background-position: center;
  
  /* Prevent tiling */
  background-repeat: no-repeat;
  
  /* Optional: fix it in place when scrolling */
  background-attachment: fixed;
} 
  h1 { text-align: center; margin-bottom: 10px; }
  .controls { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .left-controls { display:flex; gap:12px; align-items:center; }
  .search-box { padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
  .month-nav { display:flex; align-items:center; gap:10px; }
  button.btn, .nav-btn { padding: 6px 12px; border: none; background: #c20d0d; color: white; border-radius: 4px; cursor: pointer;
  /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
  button.btn:hover, .nav-btn:hover { background: #c20d0d; }
  .link-buttons { margin-top: 15px; display:flex; gap:10px; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px;
  /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; font-size: 14px; }
  th { background-color: #c20d0d; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  img { max-width: 100px; max-height: 80px; cursor: pointer; border-radius: 4px; }
  tfoot td { font-weight: bold; background: #e9ecef; }
  .right-align { text-align: right; }
  .no-data { text-align: center; margin-top: 20px; color: #666; }
  #map { height: 600px; width: 1000px; margin-top: 20px; border: 2px solid #ccc; border-radius: 6px;
   /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  
  }
</style>
</head>
<body>

  <!-- Dashboard Title -->
<h1 class="dashboard-title">
  Forest Products Transport<br>
  Monitoring Dashboard<br>
  <span class="checkpoint">Km. 48 Checkpoint</span>
</h1>

<style>
.dashboard-title {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 3rem;
  font-weight: 700;
  text-align: center;
  line-height: 1;
  color: #2d3e50;
  margin-bottom: 20px;
}
.dashboard-title .checkpoint {
  font-size: 2rem;
  font-weight: 400;
  color: #5a7684;
  display: block;
  margin-top: 10px;
  margin-bottom: 20px;
}
</style>


<div class="controls">
  <div class="left-controls">
    <input type="text" id="searchInput" class="search-box" placeholder="Search records..." onkeyup="filterTable()">
    <div class="month-nav">
      <button class="btn" onclick="changeMonth(-1)">← Prev</button>
      <span id="monthLabel">--</span>
      <button class="btn" onclick="changeMonth(1)">Next →</button>
    </div>
  </div>
  <div>
    <button class="btn" onclick="generatePDF()">Generate PDF Report</button>
  </div>
</div>

<!-- Extra navigation buttons -->
<div class="link-buttons">
  <a href="/analytics/" class="nav-btn">Analytics</a>
  <a href="#" class="nav-btn">Forms</a>
</div>

<style>
.link-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.nav-btn {
  display: inline-block;
  padding: 10px 20px;
  background-color: #2d89ef;
  color: white;
  font-weight: 600;
  border-radius: 6px;
  text-decoration: none;
  transition: all 0.25s ease;
}

.nav-btn:hover {
  background-color: #1e5bb8;
  transform: scale(1.08);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
</style>

<table id="dataTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
  <tfoot id="tableFooter"></tfoot>
</table>

<div id="noDataMessage" class="no-data" style="display:none;">No records for selected month.</div>

<!-- Map container -->
<div id="map"></div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";

let allData = [];
let currentMonthIndex = 0;
let monthList = [];
let map, markerClusterGroup;

function convertDriveLink(url) {
  if (!url) return "";
  if (url.includes("open?id=")) return url.replace("open?id=", "uc?export=view&id=");
  const match = url.match(/\/d\/([^\/]+)\/?/);
  if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  return url;
}
function formatDate(value) {
  let d;
  if (!value && value !== 0) return "";
  if (!isNaN(value) && value > 1000 && value < 60000) d = new Date((value - 25569) * 86400 * 1000);
  else d = new Date(value);
  if (isNaN(d)) return value || "";
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).toUpperCase();
}
function formatNumber(value, decimals = 2) {
  if (isNaN(Number(value))) return value || "";
  return Number(value).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function initMap() {
  map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markerClusterGroup = L.markerClusterGroup();
  map.addLayer(markerClusterGroup);
}

function addLocationsToMap(data) { 
  markerClusterGroup.clearLayers();
  const bounds = [];
  data.forEach(row => {
    const loc = (row["location"] !== undefined) ? row["location"] : row["Location"];
    if (!loc) return;
    const permittee = row["permittee"] || row["Permittee"] || "";
    const species = row["species"] || row["Species"] || "";
    const popupHtml = `<div style="font-weight:600">${escapeHtml(permittee || "Record")}</div>
                       <div style="font-size:90%">${escapeHtml(species || "Record")}</div>`;
    const parts = String(loc).split(",");
    if (parts.length >= 2) {
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (!isNaN(lat) && !isNaN(lng)) {
        const m = L.marker([lat, lng]).bindPopup(popupHtml);
        markerClusterGroup.addLayer(m);
        bounds.push([lat, lng]);
      }
    }
  });
  if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
}

function renderTable() {
  if (!allData.length) return;
  const headers = Object.keys(allData[0]);
  const tableHeader = document.getElementById("tableHeader");
  const tableBody = document.getElementById("tableBody");
  const tableFooter = document.getElementById("tableFooter");
  tableHeader.innerHTML = "";
  tableBody.innerHTML = "";
  tableFooter.innerHTML = "";
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h.toUpperCase();
    tableHeader.appendChild(th);
  });
  const month = monthList[currentMonthIndex] || null;
  document.getElementById("monthLabel").textContent = month ? formatMonthLabel(month).toUpperCase() : "--";
  const dateKey = headers.find(k => k.toLowerCase().includes("date")) || headers[0];
  const cuKey = headers.find(k => k.toLowerCase().includes("cu.m"));
  const bdKey = headers.find(k => k.toLowerCase().includes("bd.ft"));
  const piecesKey = headers.find(k => k.toLowerCase().includes("pieces"));
  let totalCu = 0, totalBd = 0, totalPieces = 0;
  const filteredData = allData.filter(row => {
    const d = new Date(row[dateKey]);
    if (isNaN(d)) return false;
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === month;
  });
  document.getElementById("noDataMessage").style.display = filteredData.length ? "none" : "block";
  filteredData.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const key = h.trim().toLowerCase();
      const td = document.createElement("td");
      if (key.includes("photo")) {
        const url = row[h];
        if (url) {
          const img = document.createElement("img");
          img.src = convertDriveLink(url);
          img.loading = "lazy";
          img.onclick = () => window.open(url, "_blank");
          td.appendChild(img);
        }
      } else if (key.includes("date")) {
        td.textContent = formatDate(row[h]);
      } else {
        td.textContent = row[h] || "";
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
    totalCu += parseFloat(row[cuKey]) || 0;
    totalBd += parseFloat(row[bdKey]) || 0;
    totalPieces += parseInt(row[piecesKey]) || 0;
  });
  const footerRow = document.createElement("tr");
  headers.forEach((h, idx) => {
    const key = h.toLowerCase();
    const td = document.createElement("td");
    if (key.includes("cu.m")) {
      td.textContent = formatNumber(totalCu) + " CU.M.";
      td.classList.add('right-align');
    } else if (key.includes("bd.ft")) {
      td.textContent = formatNumber(totalBd) + " BD.FT";
      td.classList.add('right-align');
    } else if (key.includes("pieces")) {
      td.textContent = formatNumber(totalPieces, 0) + " PIECES";
      td.classList.add('right-align');
    } else if (idx === 0) {
      td.textContent = "TOTAL:";
    }
    footerRow.appendChild(td);
  });
  tableFooter.appendChild(footerRow);
  addLocationsToMap(filteredData);
}

function changeMonth(step) {
  if (!monthList.length) return;
  currentMonthIndex = (currentMonthIndex + step + monthList.length) % monthList.length;
  renderTable();
}
function formatMonthLabel(monthStr) {
  if (!monthStr) return "--";
  const [year, month] = monthStr.split("-");
  return `${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}`;
}
function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#dataTable tbody tr").forEach(row => {
    const cells = Array.from(row.getElementsByTagName("td"));
    row.style.display = cells.some(cell => cell.textContent.toLowerCase().includes(searchValue)) ? "" : "none";
  });
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Forest Products Transport Monitoring Report", 10, 10);
  const table = document.getElementById("dataTable");
  let y = 20;
  for (let row of table.rows) {
    let rowText = Array.from(row.cells).map(cell => cell.innerText).join(" | ");
    doc.text(rowText, 10, y);
    y += 7;
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  }
  doc.save("report.pdf");
}

fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    allData = data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim()] = row[k]);
      return obj;
    });
    const dateKeyCandidate = Object.keys(allData[0] || {}).find(k => k.toLowerCase().includes("date")) || Object.keys(allData[0])[0];
    monthList = [...new Set(allData.map(r => {
      const d = new Date(r[dateKeyCandidate]);
      if (isNaN(d)) return null;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }).filter(Boolean))].sort();
    currentMonthIndex = Math.max(0, monthList.indexOf(`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`));
    initMap();
    renderTable();
  });
</script>



<script>
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.onkeydown = function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0))) {
      return false;
    }
  };
</script>
</body>
</html>
