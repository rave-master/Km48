
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Monitoring Dashboard</title>
<link rel="icon" href="https://ia601205.us.archive.org/12/items/icon_20250717/icon.png" type="image/png">

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD2xLVGe79OxzEHC2uXNMcbCtWugGn2M_k",
    authDomain: "simple-logon.firebaseapp.com",
    projectId: "simple-logon",
    storageBucket: "simple-logon.firebasestorage.app",
    messagingSenderId: "698709393716",
    appId: "1:698709393716:web:5d93c85f962769d8a42561",
    measurementId: "G-H25FHTK2S5"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Protect the page
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      // If not logged in, redirect to login page
      window.location.href = "/index.html";
    } else {
      console.log("User is signed in:", user.displayName, user.email);
      // Example: show user name on homepage
      document.getElementById("user-info").textContent =
        `Welcome, ${user.displayName || user.email}`;
    }
  });

  // Optional: Logout button
  function logout() {
    signOut(auth).then(() => {
      window.location.href = "/index.html";
    });
  }
  window.logout = logout;
</script>




<script>
    const AGREEMENT_VERSION = '2.1';

    // Check agreement in storage
    const storedVersion = sessionStorage.getItem('denr_agreement_version');
    const agreementAccepted = sessionStorage.getItem('denr_agreement_accepted');

    if (storedVersion !== AGREEMENT_VERSION || agreementAccepted !== 'true') {
        // Redirect to agreement page if not accepted
        window.location.href = '/index.html'; // Your cover page filename
    } 
</script>


<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
  body { font-family: Arial, sans-serif;
  padding: 20px;
  
  /* Background image */
  background-image: url('/de.jpg');
  
  /* Make it cover the whole screen */
  background-size: cover;
  
  /* Keep it centered */
  background-position: center;
  
  /* Prevent tiling */
  background-repeat: no-repeat;
  
  /* Optional: fix it in place when scrolling */
  background-attachment: fixed;
} 
  h1 { text-align: center; margin-bottom: 10px; }
  .controls { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .left-controls { display:flex; gap:12px; align-items:center; }
  .search-box { padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
  .month-nav { display:flex; align-items:center; gap:10px; }
  button.btn, .nav-btn { padding: 6px 12px; border: none; background: #c20d0d; color: white; border-radius: 4px; cursor: pointer;
  /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
  button.btn:hover, .nav-btn:hover { background: #c20d0d; }
  .link-buttons { margin-top: 15px; display:flex; gap:10px; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px;
  /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; font-size: 14px; }
  th { background-color: #c20d0d; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  img { max-width: 100px; max-height: 80px; cursor: pointer; border-radius: 4px; }
  tfoot td { font-weight: bold; background: #e9ecef; }
  .right-align { text-align: right; }
  .no-data { text-align: center; margin-top: 20px; color: #666; }
  #map { height: 600px; width: 1000px; margin-top: 20px; border: 2px solid #ccc; border-radius: 6px;
   /* Shadow effect */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  
  }
</style>
</head>
<body>

<!-- Top bar -->
<div class="flex justify-end p-4">
  <button 
    onclick="logout()" 
    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg shadow-md transition">
    Logout
  </button>
</div>

<!-- Philippine Date & Time -->
<div class="flex flex-col items-end p-1 text-lg font-medium text-blue-600 leading-tight" style="line-height: 1.2;">
  <p id="ph-date" class="mb-0.5"></p>
  <p id="ph-time" class="mb-0"></p>
  <div id="user-info" class="flex justify-end items-center gap-2 p-1 text-lg font-medium text-gray-700 mt-2">
  <!-- Profile photo -->
  <img src="https://via.placeholder.com/40" alt="Profile Photo" class="w-10 h-10 rounded-full border border-gray-300">

  <!-- User name or info -->
  <span id="user-name">John Doe</span>
</div>
</div>


<script>
function updatePhilippineDateTime() {
  const now = new Date();

  // Format date: "Wednesday, August 20, 2025"
  const dateOptions = {
    timeZone: "Asia/Manila",
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  };
  const formattedDate = new Intl.DateTimeFormat("en-US", dateOptions).format(now);

  // Format time: "11:41:15 AM"
  const timeOptions = {
    timeZone: "Asia/Manila",
    hour12: true,
    hour: "numeric",  // no leading zero
    minute: "2-digit",
    second: "2-digit"
  };
  const formattedTime = new Intl.DateTimeFormat("en-US", timeOptions).format(now);

  document.getElementById("ph-date").textContent = formattedDate;
  document.getElementById("ph-time").textContent = `Philippine Standard Time: ${formattedTime}`;
}

// Update every second
setInterval(updatePhilippineDateTime, 1000);
updatePhilippineDateTime();
</script>

  <!-- Dashboard Title -->
<h1 class="dashboard-title">
  Forest Products Transport<br>
  Monitoring Dashboard<br>
  <span class="checkpoint">Km. 48 Checkpoint</span>
</h1>

<style>
  
.dashboard-title {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 3rem;
  font-weight: 700;
  text-align: center;
  line-height: 1;
  color: #2d3e50;
  margin-bottom: 20px;
}
.dashboard-title .checkpoint {
  font-size: 2rem;
  font-weight: 400;
  color: #5a7684;
  display: block;
  margin-top: 10px;
  margin-bottom: 20px;
}
</style>


<div class="controls">
  <div class="left-controls">
    <input type="text" id="searchInput" class="search-box" placeholder="Search records..." onkeyup="filterTable()">
    <div class="month-nav">
      <button class="btn" onclick="changeMonth(-1)">← Prev</button>
      <span id="monthLabel">--</span>
      <button class="btn" onclick="changeMonth(1)">Next →</button>
    </div>
  </div>


<!-- Extra navigation buttons -->
<div class="link-buttons">
  <a href="/analytics/" class="nav-btn">Analytics</a>
  <a href="#" class="nav-btn">Forms</a>
</div>

<style>
.link-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.nav-btn {
  display: inline-block;
  padding: 10px 20px;
  background-color: #2d89ef;
  color: white;
  font-weight: 600;
  border-radius: 6px;
  text-decoration: none;
  transition: all 0.25s ease;
}

.nav-btn:hover {
  background-color: #1e5bb8;
  transform: scale(1.08);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
</style>

<table id="dataTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
  <tfoot id="tableFooter"></tfoot>
</table>

<div id="noDataMessage" class="no-data" style="display:none;">No records for selected month.</div>

<!-- Map container -->
<div id="map"></div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";

let allData = [];
let currentMonthIndex = 0;
let monthList = [];
let map, markerClusterGroup;

function convertDriveLink(url) {
  if (!url) return "";
  if (url.includes("open?id=")) return url.replace("open?id=", "uc?export=view&id=");
  const match = url.match(/\/d\/([^\/]+)\/?/);
  if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  return url;
}
function formatDate(value) {
  if (!value) return "";

  let d;

  // Handle Excel serial numbers
  if (!isNaN(value) && value > 1000 && value < 60000) {
    d = new Date((value - 25569) * 86400 * 1000);
  } else {
    d = new Date(value); // Parse as UTC if it has 'Z'
  }

  if (isNaN(d.getTime())) return value || "";

  // Check if time portion is exactly midnight
  const isMidnight =
    d.getHours() === 0 &&
    d.getMinutes() === 0 &&
    d.getSeconds() === 0;

  // Date-only if midnight, otherwise date + time
  const options = isMidnight
    ? {
        timeZone: "Asia/Singapore", // works for Philippines too
        year: "numeric",
        month: "short",
        day: "2-digit",
      }
    : {
        timeZone: "Asia/Singapore",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true,
      };

  return d.toLocaleString("en-US", options).toUpperCase();
}



function formatNumber(value, decimals = 2) {
  if (isNaN(Number(value))) return value || "";
  return Number(value).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function initMap() {
  map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markerClusterGroup = L.markerClusterGroup();
  map.addLayer(markerClusterGroup);
}

function addLocationsToMap(data) { 
  markerClusterGroup.clearLayers();
  const bounds = [];
  data.forEach(row => {
    const loc = (row["location"] !== undefined) ? row["location"] : row["Location"];
    if (!loc) return;
    const permittee = row["permittee"] || row["Permittee"] || "";
    const species = row["species"] || row["Species"] || "";
    const popupHtml = `<div style="font-weight:600">${escapeHtml(permittee || "Record")}</div>
                       <div style="font-size:90%">${escapeHtml(species || "Record")}</div>`;
    const parts = String(loc).split(",");
    if (parts.length >= 2) {
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (!isNaN(lat) && !isNaN(lng)) {
        const m = L.marker([lat, lng]).bindPopup(popupHtml);
        markerClusterGroup.addLayer(m);
        bounds.push([lat, lng]);
      }
    }
  });
  if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
}

function renderTable() {
  if (!allData.length) return;
  const headers = Object.keys(allData[0]);
  const tableHeader = document.getElementById("tableHeader");
  const tableBody = document.getElementById("tableBody");
  const tableFooter = document.getElementById("tableFooter");
  tableHeader.innerHTML = "";
  tableBody.innerHTML = "";
  tableFooter.innerHTML = "";
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h.toUpperCase();
    tableHeader.appendChild(th);
  });
  const month = monthList[currentMonthIndex] || null;
  document.getElementById("monthLabel").textContent = month ? formatMonthLabel(month).toUpperCase() : "--";
  const dateKey = headers.find(k => k.toLowerCase().includes("date")) || headers[0];
  const cuKey = headers.find(k => k.toLowerCase().includes("cu.m"));
  const bdKey = headers.find(k => k.toLowerCase().includes("bd.ft"));
  const piecesKey = headers.find(k => k.toLowerCase().includes("pieces"));
  let totalCu = 0, totalBd = 0, totalPieces = 0;
  const filteredData = allData.filter(row => {
    const d = new Date(row[dateKey]);
    if (isNaN(d)) return false;
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === month;
  });
  document.getElementById("noDataMessage").style.display = filteredData.length ? "none" : "block";
  filteredData.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const key = h.trim().toLowerCase();
      const td = document.createElement("td");
      if (key.includes("photo")) {
        const url = row[h];
        if (url) {
          const img = document.createElement("img");
          img.src = convertDriveLink(url);
          img.loading = "lazy";
          img.onclick = () => window.open(url, "_blank");
          td.appendChild(img);
        }
      } else if (key.includes("timestamp")) {
    // Show original UTC + converted local time
    const localTime = formatDate(row[h]);
    td.innerHTML = `${row[h]}<br><small style="color:gray;">${localTime}</small>`;
} else if (key.includes("date")) {
    td.textContent = formatDate(row[h]);

      } else {
        td.textContent = row[h] || "";
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
    totalCu += parseFloat(row[cuKey]) || 0;
    totalBd += parseFloat(row[bdKey]) || 0;
    totalPieces += parseInt(row[piecesKey]) || 0;
  });
  const footerRow = document.createElement("tr");
  headers.forEach((h, idx) => {
    const key = h.toLowerCase();
    const td = document.createElement("td");
    if (key.includes("cu.m")) {
      td.textContent = formatNumber(totalCu) + " CU.M.";
      td.classList.add('right-align');
    } else if (key.includes("bd.ft")) {
      td.textContent = formatNumber(totalBd) + " BD.FT";
      td.classList.add('right-align');
    } else if (key.includes("pieces")) {
      td.textContent = formatNumber(totalPieces, 0) + " PIECES";
      td.classList.add('right-align');
    } else if (idx === 0) {
      td.textContent = "TOTAL:";
    }
    footerRow.appendChild(td);
  });
  tableFooter.appendChild(footerRow);
  addLocationsToMap(filteredData);
}

function changeMonth(step) {
  if (!monthList.length) return;
  currentMonthIndex = (currentMonthIndex + step + monthList.length) % monthList.length;
  renderTable();
}
function formatMonthLabel(monthStr) {
  if (!monthStr) return "--";
  const [year, month] = monthStr.split("-");
  return `${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}`;
}
function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#dataTable tbody tr").forEach(row => {
    const cells = Array.from(row.getElementsByTagName("td"));
    row.style.display = cells.some(cell => cell.textContent.toLowerCase().includes(searchValue)) ? "" : "none";
  });
}


fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    allData = data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim()] = row[k]);
      return obj;
    });
    const dateKeyCandidate = Object.keys(allData[0] || {}).find(k => k.toLowerCase().includes("date")) || Object.keys(allData[0])[0];
    monthList = [...new Set(allData.map(r => {
      const d = new Date(r[dateKeyCandidate]);
      if (isNaN(d)) return null;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }).filter(Boolean))].sort();
    currentMonthIndex = Math.max(0, monthList.indexOf(`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`));
    initMap();
    renderTable();
  });
</script>



<script>
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.onkeydown = function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0))) {
      return false;
    }
  };
</script>
</body>
</html>
